<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Skill Match AI - Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{{ url_for('static', filename='dashboard.css') }}">
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none'><path d='m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z' fill='%236366f1'/></svg>">
    <!-- GSAP for Professional Animations -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 50px;
            font-size: 0.75rem;
            font-weight: 700;
        }

        .status-badge[data-score] {
            background: var(--bg-hover);
        }
    </style>
</head>

<body>
    <!-- Theme Toggle -->
    <button id="themeToggle" class="theme-toggle-btn" title="Toggle Theme" style="display: none;">
        Theme
    </button>

    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="nav-left">
                <a href="/" class="logo">
                    <div class="logo-icon">
                        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path
                                d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"
                                fill="url(#ai-grad)" />
                            <circle cx="12" cy="12" r="4" fill="white" fill-opacity="0.2" />
                            <path d="m9 12 2 2 4-4" stroke="white" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round" />
                            <defs>
                                <linearGradient id="ai-grad" x1="3" y1="3" x2="21" y2="21"
                                    gradientUnits="userSpaceOnUse">
                                    <stop stop-color="#6366f1" />
                                    <stop offset="1" stop-color="#a855f7" />
                                </linearGradient>
                            </defs>
                        </svg>
                    </div>
                    <h1>Skill Match AI</h1>
                </a>
                <nav class="nav-links">
                    <a href="#" class="nav-link active" id="navDashboard"
                        onclick="switchView('dashboard'); return false;">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="3" y="3" width="7" height="7"></rect>
                            <rect x="14" y="3" width="7" height="7"></rect>
                            <rect x="14" y="14" width="7" height="7"></rect>
                            <rect x="3" y="14" width="7" height="7"></rect>
                        </svg>
                        Dashboard
                    </a>
                    <a href="#" class="nav-link" id="navNewMatch" onclick="switchView('newMatch'); return false;">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                            <line x1="12" y1="18" x2="12" y2="12"></line>
                            <line x1="9" y1="15" x2="15" y2="15"></line>
                        </svg>
                        New Match
                    </a>
                    <a href="#" class="nav-link" id="navSimulator" onclick="switchView('simulator'); return false;">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                        </svg>
                        Simulator
                    </a>
                    <a href="#" class="nav-link" id="navSalary" onclick="openSalaryModal(); return false;">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="12" y1="1" x2="12" y2="23"></line>
                            <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                        </svg>
                        Salary
                    </a>
                </nav>
            </div>

            <div class="nav-right">
                <button id="themeToggleIcon" class="theme-toggle-btn">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                </button>
                <!-- AI Assistant Button in Navbar -->
                <button id="navChatBtn" class="nav-chat-btn" onclick="toggleChat()" title="AI Assistant">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                    </svg>
                    <span>AI Assistant</span>
                </button>
                <div class="user-profile" id="userProfileBtn">
                    <div class="avatar">
                        {{ (user.name | default('Guest'))[:2].upper() }}
                    </div>
                    <div class="user-text">
                        <span class="user-display-name">{{ user.name | default('Guest') }}</span>
                        <span class="user-display-email">{{ user.email | default('') }}</span>
                    </div>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="6 9 12 15 18 9"></polyline>
                    </svg>

                    <div class="profile-dropdown">
                        <a href="#" class="dropdown-item" onclick="openProfileModal(); return false;">Your Profile</a>
                        <a href="#" class="dropdown-item" onclick="openSettingsModal(); return false;">Settings</a>
                        <a href="/logout" class="dropdown-item logout">Sign out</a>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container">
        <!-- Dashboard View -->
        <div id="dashboardView" class="view-content fade-in">
            <div class="page-header">
                <div class="page-title-group">
                    <h2>Dashboard</h2>
                    <p>Welcome back! Here's an overview of your resume matching activity.</p>
                </div>
                <button class="btn-primary" onclick="showNewMatch()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    New Match
                </button>
            </div>

            <!-- Metrics -->
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-header">
                        <div class="metric-icon">Total</div>
                        <span class="metric-trend trend-up">+12%</span>
                    </div>
                    <div class="metric-body">
                        <h3>{{ stats.total }}</h3>
                        <p>Total Matches</p>
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-header">
                        <div class="metric-icon">Score</div>
                        <span class="metric-trend trend-up">+5%</span>
                    </div>
                    <div class="metric-body">
                        <h3>{{ stats.avg }}</h3>
                        <p>Avg. Match Score</p>
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-header">
                        <div class="metric-icon">Roles</div>
                        <span class="metric-trend trend-up">+2</span>
                    </div>
                    <div class="metric-body">
                        <h3>{{ stats.roles }}</h3>
                        <p>Active Roles</p>
                    </div>
                </div>
                <div class="metric-card">
                    <div class="metric-header">
                        <div class="metric-icon">Recent</div>
                        <span class="metric-trend trend-up">+8</span>
                    </div>
                    <div class="metric-body">
                        <h3>{{ stats.week }}</h3>
                        <p>This Week</p>
                    </div>
                </div>
            </div>

            <!-- Recent Matches -->
            <div class="section-card">
                <div class="section-header">
                    <div class="section-title-group">
                        <h3>Recent Matches</h3>
                        <p>Your latest resume-to-role comparisons</p>
                    </div>
                    <a href="#" class="view-all-link">View all</a>
                </div>
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>Candidate</th>
                                <th>Role</th>
                                <th>Match Score</th>
                                <th>Status</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if recent_matches %}
                            {% for match in recent_matches %}
                            <tr>
                                <td>
                                    <div class="candidate-cell">
                                        <div class="candidate-avatar">{{ match.candidate[:2] | upper }}</div>
                                        <span class="candidate-name">{{ match.candidate }}</span>
                                    </div>
                                </td>
                                <td>{{ match.role }}</td>
                                <td><span
                                        class="score-badge {% if match.score >= 80 %}score-high{% elif match.score >= 50 %}score-mid{% else %}score-low{% endif %}">{{
                                        match.score }}%</span></td>
                                <td>
                                    <span
                                        class="status-badge {% if match.score >= 80 %}status-strong{% elif match.score >= 50 %}status-average{% else %}status-needs-review{% endif %}">
                                        {% if match.score >= 80 %}Strong{% elif match.score >= 50 %}Average{% else
                                        %}Needs Review{% endif %}
                                    </span>
                                </td>
                                <td>{{ match.date }}</td>
                                <td><a href="#" class="actions-btn"
                                        onclick="showDetailedAnalysis({{ loop.index0 }}, true); return false;">View
                                        ‚Üó</a></td>
                            </tr>
                            {% endfor %}
                            {% else %}
                            <tr>
                                <td colspan="6" style="text-align: center; padding: 3rem; color: var(--text-muted);">
                                    No matches yet. Click "New Match" to get started.
                                </td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- New Match View (Initially Hidden) -->
        <div id="newMatchView" class="view-content fade-in" style="display: none;">
            <div class="page-header">
                <div class="page-title-group">
                    <h2>New Resume Match</h2>
                    <p>Upload a resume and provide job details to analyze the match score and skill gaps.</p>
                </div>
            </div>

            {% if error_message %}
            <div class="error-banner"
                style="background: rgba(239, 68, 68, 0.1); color: #EF4444; padding: 1rem; border-radius: 12px; margin-bottom: 2rem; border: 1px solid rgba(239, 68, 68, 0.2); font-weight: 600; text-align: center;">
                ‚ö†Ô∏è {{ error_message }}
            </div>
            {% endif %}

            <form method="POST" class="form-grid" enctype="multipart/form-data">
                <!-- Job Description Card -->
                <div class="form-section fade-in">
                    <div class="form-section-header">
                        <div class="form-icon">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect>
                                <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path>
                            </svg>
                        </div>
                        <div class="form-title-group">
                            <h3>Job Details</h3>
                            <p>Provide the role and requirements to match against</p>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Job Title</label>
                        <input type="text" name="job_title" class="input-field"
                            placeholder="e.g. Senior Product Manager">
                    </div>

                    <div class="form-group">
                        <label>Job Description</label>
                        <textarea name="job_description"
                            placeholder="Paste full job description or just a title like 'Software Engineer at Google'..."
                            required class="input-field"></textarea>
                    </div>
                </div>

                <!-- Resumes Card -->
                <div class="form-section fade-in" style="animation-delay: 0.1s">
                    <div class="form-section-header">
                        <div class="form-icon">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                                <line x1="16" y1="13" x2="8" y2="13"></line>
                                <line x1="16" y1="17" x2="8" y2="17"></line>
                                <polyline points="10 9 9 9 8 9"></polyline>
                            </svg>
                        </div>
                        <div class="form-title-group">
                            <h3>Resume Upload</h3>
                            <p>Upload the candidate's resume in PDF or DOCX format</p>
                        </div>
                    </div>

                    <!-- Tab Buttons -->
                    <div class="tab-container">
                        <button type="button" class="tab-btn active" data-tab="paste">Paste Text</button>
                        <button type="button" class="tab-btn" data-tab="upload">Upload Document</button>
                    </div>

                    <div class="form-body">
                        <!-- Paste Tab Content -->
                        <div class="tab-content active" id="paste-tab">
                            <textarea name="resumes" id="resumes-textarea"
                                placeholder="Paste candidate resumes here... (separate each resume with a blank line)"
                                class="input-field" rows="8"></textarea>
                        </div>

                        <!-- Upload Tab Content -->
                        <div class="tab-content" id="upload-tab">
                            <div class="file-upload-zone" id="dropZone"
                                onclick="document.getElementById('resume_files').click()">
                                <div class="upload-icon">
                                    <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                        <polyline points="17 8 12 3 7 8"></polyline>
                                        <line x1="12" y1="3" x2="12" y2="15"></line>
                                    </svg>
                                </div>
                                <p class="upload-text"><span>Click to upload</span> or drag and drop</p>
                                <p class="upload-subtext">PDF or DOCX (max. 5MB)</p>
                                <input type="file" name="resume_files" id="resume_files" multiple
                                    accept=".pdf,.docx,.doc,.txt" style="display: none;">
                            </div>
                            <div class="file-list" id="fileList"></div>
                        </div>
                    </div>
                </div>

                <!-- Submit Button -->
                <button type="submit" class="btn-primary fade-in"
                    style="animation-delay: 0.2s; width: 100%; justify-content: center; padding: 1rem;">
                    <span>Evaluate Candidates</span>
                </button>
            </form>

            <!-- Results Section -->
            {% if results %}
            <div class="results-section fade-in" style="margin-top: 3rem;">
                {% if expanded_jd %}
                <div class="expansion-banner"
                    style="display: flex; gap: 1rem; align-items: flex-start; background: var(--primary-light); border: 1px solid var(--primary); padding: 1.5rem; border-radius: 12px; margin-bottom: 2rem;">
                    <div class="banner-icon" style="font-size: 1.5rem;">ü§ñ</div>
                    <div class="banner-content">
                        <h4 style="font-weight: 700; margin-bottom: 0.25rem; color: var(--primary);">AI Requirement
                            Intelligence</h4>
                        <p style="font-size: 0.875rem; color: var(--text-muted);">Detected short title. Automatically
                            expanded into industry-standard requirements for precise matching.</p>
                    </div>
                </div>
                {% endif %}

                <div class="page-header">
                    <div class="page-title-group">
                        <h3>Analysis Results</h3>
                        <p>{{ results|length }} profiles analyzed</p>
                    </div>
                </div>

                <div class="results-grid">
                    {% for r in results %}
                    <div class="result-card fade-in" style="animation-delay: {{ loop.index0 * 0.1 }}s">
                        <div class="result-header">
                            <div class="rank-badge">0{{ r.resume_no }}</div>
                            <div class="candidate-info">
                                <h3>Candidate {{ r.resume_no }} {% if r.is_top_tier %}<span class="top-tier-badge">‚≠ê Top
                                        10% Match</span>{% endif %}</h3>
                                <p>{{ r.role_focus }}</p>
                            </div>
                            <div class="match-score-radial">
                                <span class="score-value">{{ r.score }}%</span>
                                <span class="score-label">Match</span>
                            </div>
                        </div>

                        <div class="score-container">
                            <div class="score-bar">
                                <div class="score-fill" data-score="{{ r.score }}">
                                </div>
                            </div>
                        </div>

                        <div class="match-label" style="margin-bottom: 1.5rem;">
                            {% if r.score >= 70 %}
                            <span class="status-badge status-strong">Excellent Match</span>
                            {% elif r.score >= 50 %}
                            <span class="status-badge"
                                style="background: var(--warning-light); color: var(--warning);">Good
                                Match</span>
                            {% else %}
                            <span class="status-badge"
                                style="background: var(--danger-light); color: var(--danger);">Needs
                                Review</span>
                            {% endif %}
                        </div>

                        <!-- Advanced Analysis (Simplified in summary) -->
                        <div class="ats-insights"
                            style="background: var(--bg-main); padding: 1.25rem; border-radius: 12px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
                                <span style="font-size: 0.75rem; font-weight: 600; color: var(--text-muted);">Role
                                    Focus: <span style="color: var(--primary);">{{ r.role_focus }}</span></span>
                                <span style="font-size: 0.75rem; font-weight: 700; color: var(--text-main);">ATS: {{
                                    r.ats_score }}%</span>
                            </div>

                            {% if r.missing_skills %}
                            <div style="margin-bottom: 1rem;">
                                <p
                                    style="font-size: 0.625rem; font-weight: 700; text-transform: uppercase; color: var(--text-muted); margin-bottom: 0.5rem;">
                                    Skill Gaps</p>
                                <div style="display: flex; flex-wrap: wrap; gap: 0.4rem;">
                                    {% for skill in r.missing_skills %}
                                    <span
                                        style="font-size: 0.6875rem; padding: 0.2rem 0.5rem; background: var(--danger-light); color: var(--danger); border-radius: 4px;">{{
                                        skill }}</span>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}

                            <p style="font-size: 0.8125rem; color: var(--text-muted); line-height: 1.4;">{{
                                r.ats_summary[:150] }}...</p>
                        </div>

                        <!-- NEW: Feedback Loop Section -->
                        {% if r.feedback_loop %}
                        <div class="feedback-loop-section"
                            style="background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(168, 85, 247, 0.1)); padding: 1rem; border-radius: 12px; margin-top: 1rem; border: 1px solid rgba(99, 102, 241, 0.2);">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
                                <span style="font-size: 0.75rem; font-weight: 700; color: var(--primary);">To Reach Top
                                    10%</span>
                                <span
                                    style="margin-left: auto; font-size: 0.625rem; padding: 0.2rem 0.5rem; background: var(--primary); color: white; border-radius: 20px;">+{{
                                    r.feedback_loop.gap_to_top_10 }} pts needed</span>
                            </div>
                            {% if r.feedback_loop.quick_wins %}
                            <div style="font-size: 0.75rem; color: var(--text-main);">
                                {% for win in r.feedback_loop.quick_wins[:2] %}
                                <div
                                    style="display: flex; align-items: flex-start; gap: 0.4rem; margin-bottom: 0.4rem;">
                                    <span style="color: var(--success);">‚úì</span>
                                    <span>{{ win }}</span>
                                </div>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        {% endif %}

                        <!-- NEW: Company-Style Fit Badge -->
                        {% if r.company_style_fit %}
                        <div class="style-fit-section"
                            style="background: var(--bg-main); padding: 1rem; border-radius: 12px; margin-top: 0.75rem;">
                            <div style="display: flex; align-items: center; justify-content: space-between;">
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span style="font-size: 0.75rem; font-weight: 600; color: var(--text-muted);">Style
                                        Fit:</span>
                                    {% if 'Google' in r.company_style_fit.best_fit_culture %}
                                    <div
                                        style="display: flex; align-items: center; gap: 0.4rem; background: #f1f5f9; padding: 0.25rem 0.75rem; border-radius: 20px; border: 1px solid #e2e8f0;">
                                        <svg width="14" height="14" viewBox="0 0 24 24"
                                            xmlns="http://www.w3.org/2000/svg">
                                            <path
                                                d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"
                                                fill="#4285F4" />
                                            <path
                                                d="M12 23c3.11 0 5.71-1.02 7.62-2.77l-3.57-2.77c-.99.66-2.23 1.06-4.05 1.06-3.11 0-5.74-2.11-6.68-4.96H1.74v2.85C3.64 20.31 7.6 23 12 23z"
                                                fill="#34A853" />
                                            <path
                                                d="M5.32 13.56c-.24-.71-.37-1.47-.37-2.26s.13-1.55.37-2.26V6.19H1.74c-.8 1.6-1.25 3.39-1.25 5.31s.45 3.71 1.25 5.31l3.58-2.84z"
                                                fill="#FBBC05" />
                                            <path
                                                d="M12 4.75c1.69 0 3.21.58 4.41 1.71l3.3-3.3C17.69 1.02 15.11 0 12 0 7.6 0 3.64 2.69 1.74 6.19l3.58 2.84c.94-2.85 3.57-4.96 6.68-4.96z"
                                                fill="#EA4335" />
                                        </svg>
                                        <span
                                            style="font-size: 0.75rem; font-weight: 700; color: #1e293b;">Google</span>
                                    </div>
                                    {% else %}
                                    <span
                                        style="font-size: 0.75rem; font-weight: 700; padding: 0.25rem 0.6rem; background: {% if 'Microsoft' in r.company_style_fit.best_fit_culture %}#0078D4{% elif 'Startup' in r.company_style_fit.best_fit_culture %}#10B981{% else %}#8B5CF6{% endif %}; color: white; border-radius: 20px;">{{
                                        r.company_style_fit.best_fit_culture }}</span>
                                    {% endif %}
                                </div>
                                <span class="status-badge" data-score="{{ r.company_style_fit.fit_score }}">{{
                                    r.company_style_fit.fit_score }}%</span>
                            </div>
                            {% if r.company_style_fit.style_summary %}
                            <p
                                style="font-size: 0.6875rem; color: var(--text-muted); margin-top: 0.5rem; font-style: italic;">
                                "{{ r.company_style_fit.style_summary[:100] }}{% if
                                r.company_style_fit.style_summary|length > 100
                                %}...{% endif %}"</p>
                            {% endif %}
                        </div>
                        {% endif %}

                        <!-- NEW: Evolution Delta Section (Summary Card) -->
                        {% if r.evolution %}
                        <div class="evolution-summary-badge"
                            style="background: {% if r.evolution.delta > 0 %}var(--success-light){% elif r.evolution.delta < 0 %}var(--danger-light){% else %}var(--bg-main){% endif %}; padding: 0.5rem 0.75rem; border-radius: 8px; margin-top: 0.75rem; border: 1px dashed {% if r.evolution.delta > 0 %}var(--success){% elif r.evolution.delta < 0 %}var(--danger){% else %}var(--border){% endif %};">
                            <div style="display: flex; align-items: center; justify-content: space-between;">
                                <div style="display: flex; align-items: center; gap: 0.4rem;">
                                    <span
                                        style="font-size: 0.75rem; font-weight: 700; color: {% if r.evolution.delta > 0 %}var(--success){% elif r.evolution.delta < 0 %}var(--danger){% else %}var(--text-muted){% endif %};">
                                        {% if r.evolution.delta > 0 %}+{{ r.evolution.delta }}% Progression{% elif
                                        r.evolution.delta < 0 %}{{ r.evolution.delta }}% Regression{% else %}Steady
                                            State{% endif %} </span>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <div style="display: flex; gap: 1rem; align-items: center; margin-top: 1.5rem;">
                            <a href="#" onclick="showDetailedAnalysis({{ loop.index0 }}); return false;"
                                style="font-size: 0.8125rem; font-weight: 600; color: var(--primary); text-decoration: none;">View
                                Detail ‚Üó</a>
                            <a href="/modify-resume?content={{ r.content | urlencode }}&jd={{ (job_description + '\n' + (job_title or '')) | urlencode }}"
                                class="btn-secondary" style="font-size: 0.75rem; padding: 0.5rem 0.75rem;">Improve with
                                AI</a>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        </div>

        <!-- Rejection Simulator View (Initially Hidden) -->
        <div id="simulatorView" class="view-content fade-in" style="display: none;">
            <div class="page-header">
                <div class="page-title-group">
                    <h2>Hiring Manager Rejection Simulator</h2>
                    <p>Get brutally honest feedback on why your resume might be rejected by a specific company.</p>
                </div>
            </div>

            <div class="simulator-container">
                <div class="form-section">
                    <div class="form-section-header">
                        <div class="form-title-group">
                            <h3>Simulation Parameters</h3>
                            <p>Enter the company and role to simulate the decision-making process</p>
                        </div>
                    </div>

                    <div class="form-grid"
                        style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-top: 1.5rem;">
                        <div class="form-group">
                            <label>Target Company</label>
                            <input type="text" id="sim_company" class="input-field"
                                placeholder="e.g. Microsoft, Google, Stripe">
                        </div>
                        <div class="form-group">
                            <label>Target Role</label>
                            <input type="text" id="sim_role" class="input-field"
                                placeholder="e.g. Senior SWE, Product Manager">
                        </div>
                    </div>

                    <div class="form-group" style="margin-top: 1.5rem;">
                        <label>Resume Content</label>
                        <textarea id="sim_resume" class="input-field" rows="10"
                            placeholder="Paste your resume text here..."></textarea>
                    </div>

                    <button id="runSimulatorBtn" class="btn-primary"
                        style="width: 100%; margin-top: 1.5rem; height: 50px; font-weight: 700;">
                        <span>Simulate My Rejection</span>
                    </button>
                </div>

                <!-- Simulation Results (JS populated) -->
                <div id="simulatorResults" style="display: none; margin-top: 3rem;">
                    <div class="results-header" style="margin-bottom: 2rem;">
                        <h3 style="font-size: 1.5rem; font-weight: 800; color: var(--text-main);">Simulation Analysis
                        </h3>
                        <p style="color: var(--text-muted);">Based on decision modeling for the specified role</p>
                    </div>

                    <div id="simResultContent">
                        <!-- Content here -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Detailed Analysis View (Initially Hidden) -->
    <div id="analysisView" class="view-content fade-in"
        style="display: none; padding-top: 80px; max-width: 1200px; margin: 0 auto;">
        <div class="page-header" style="margin-bottom: 2rem;">
            <div class="page-title-group">
                <a href="#" onclick="showDashboard(); return false;"
                    style="display: flex; align-items: center; gap: 0.5rem; text-decoration: none; color: var(--text-muted); margin-bottom: 1rem; font-size: 0.875rem;">
                    ‚Üê Back to Dashboard
                </a>
                <h2>Match Analysis Results</h2>
                <p>Detailed comparison and skill gap analysis</p>
            </div>
            <div class="header-actions" style="display: flex; gap: 1rem;">
                <button class="btn-secondary" onclick="shareAnalysis()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="18" cy="5" r="3"></circle>
                        <circle cx="6" cy="12" r="3"></circle>
                        <circle cx="18" cy="19" r="3"></circle>
                        <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
                        <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
                    </svg>
                    Share
                </button>
                <button class="btn-primary" onclick="exportToPDF()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="7 10 12 15 17 10"></polyline>
                        <line x1="12" y1="15" x2="12" y2="3"></line>
                    </svg>
                    Export PDF
                </button>
            </div>
        </div>

        <div class="analysis-grid" id="detailed-analysis-content">
            <!-- Data will be populated by JS -->
        </div>
    </div>

    <!-- AI Assistant Side Drawer -->
    <div class="chat-window" id="chatWindow">
        <div class="chat-header">
            <h3>AI Assistant</h3>
            <button class="chat-close" id="closeChat">‚úï</button>
        </div>
        <div class="chat-messages" id="chatMessages">
            <div class="message message-ai">
                Hello. I'm the Skill Match AI assistant. How can I assist you with your hiring analysis today?
            </div>
        </div>
        <div class="chat-footer">
            <div class="chat-input-container">
                <input type="text" class="chat-input" id="chatInput" placeholder="Ask me anything...">
                <button class="chat-send" id="sendBtn">‚û§</button>
            </div>
        </div>
    </div>

    <script>
        // View Management
        const navDashboard = document.getElementById('navDashboard');
        const navNewMatch = document.getElementById('navNewMatch');
        const navSimulator = document.getElementById('navSimulator');
        const dashboardView = document.getElementById('dashboardView');
        const newMatchView = document.getElementById('newMatchView');
        const simulatorView = document.getElementById('simulatorView');



        // Auto-show views
        {% if results %}
        showNewMatch();
        {% else %}
        const lastView = localStorage.getItem('lastView');
        if (lastView === 'newMatch') showNewMatch();
        else if (lastView === 'simulator') showSimulator();
        else showDashboard();
        {% endif %}

        // Simulator Logic
        const runSimulatorBtn = document.getElementById('runSimulatorBtn');
        const simResultContent = document.getElementById('simResultContent');
        const simulatorResults = document.getElementById('simulatorResults');

        runSimulatorBtn.addEventListener('click', async () => {
            const company = document.getElementById('sim_company').value.trim();
            const role = document.getElementById('sim_role').value.trim();
            const resume = document.getElementById('sim_resume').value.trim();

            if (!company || !role || !resume) {
                alert("Please fill in all fields (Company, Role, and Resume Content)");
                return;
            }

            runSimulatorBtn.disabled = true;
            runSimulatorBtn.innerHTML = '<span>Thinking like a Hiring Manager...</span>';

            try {
                const response = await fetch('/rejection-simulator', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ company, role, resume })
                });

                const data = await response.json();

                if (data.status === 'success') {
                    displaySimResults(data.data);
                } else {
                    alert("Error: " + data.error);
                }
            } catch (err) {
                console.error(err);
                alert("An error occurred during simulation.");
            } finally {
                runSimulatorBtn.disabled = false;
                runSimulatorBtn.innerHTML = '<span>Simulate My Rejection</span>';
            }
        });

        function displaySimResults(res) {
            simulatorResults.style.display = 'block';

            simResultContent.innerHTML = `
                <div class="sim-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                    <!-- Risks and Monologue -->
                    <div class="sim-left">
                        <div class="panel-card" style="background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; padding: 2rem; margin-bottom: 2rem;">
                            <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1.5rem;">
                                <div style="width: 40px; height: 40px; background: #EF4444; color: white; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.25rem;">!</div>
                                <h4 style="font-weight: 800; font-size: 1.125rem;">Top Rejection Risks</h4>
                            </div>
                            <ul style="list-style: none; padding: 0;">
                                ${res.rejection_risks.map(risk => `
                                    <li style="display: flex; align-items: flex-start; gap: 0.75rem; margin-bottom: 1rem; color: var(--text-main); font-size: 0.9375rem;">
                                        <span style="color: #EF4444; font-weight: 800;">‚Ä¢</span>
                                        <span>${risk}</span>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>

                        <div class="panel-card" style="background: linear-gradient(135deg, #1F2937, #111827); border: 1px solid #374151; border-radius: 16px; padding: 2rem; color: white;">
                            <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1.25rem;">
                                <span style="font-size: 1.5rem;">Info</span>
                                <h4 style="font-weight: 700; color: #9CA3AF; text-transform: uppercase; letter-spacing: 0.05em; font-size: 0.75rem;">Internal Monologue</h4>
                            </div>
                            <p style="font-size: 1.25rem; font-weight: 500; line-height: 1.5; font-style: italic;">
                                "${res.internal_monologue}"
                            </p>
                            <p style="margin-top: 1.5rem; font-size: 0.75rem; color: #6B7280; text-align: right;">‚Äî Anonymous Hiring Manager</p>
                        </div>
                    </div>

                    <!-- Doubt and Fixes -->
                    <div class="sim-right">
                        <div class="panel-card" style="background: rgba(254, 243, 199, 0.4); border: 1px solid #FCD34D; border-radius: 16px; padding: 2rem; margin-bottom: 2rem;">
                            <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1.5rem;">
                                <div style="width: 40px; height: 40px; background: #F59E0B; color: white; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.25rem;">?</div>
                                <h4 style="font-weight: 800; font-size: 1.125rem;">The 'Line of Doubt'</h4>
                            </div>
                            <div style="background: white; padding: 1.25rem; border-radius: 12px; border-left: 4px solid #F59E0B;">
                                <p style="font-family: 'Courier New', Courier, monospace; font-size: 0.875rem; color: #1F2937; margin: 0;">
                                    "${res.line_of_doubt}"
                                </p>
                            </div>
                            <p style="margin-top: 1rem; font-size: 0.8125rem; color: var(--text-muted); line-height: 1.5;">
                                This specific detail signaled a potential lack of alignment or ramp-up risk during the initial scan.
                            </p>
                        </div>

                        <div class="panel-card" style="background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; padding: 2rem;">
                            <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1.5rem;">
                                <div style="width: 40px; height: 40px; background: #10B981; color: white; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.25rem;">+</div>
                                <h4 style="font-weight: 800; font-size: 1.125rem;">Strategic Fixes</h4>
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 1rem;">
                                ${res.strategic_fixes.map((fix, idx) => `
                                    <div style="display: flex; gap: 1rem; align-items: flex-start;">
                                        <div style="width: 24px; height: 24px; border-radius: 50%; background: #10B98120; color: #10B981; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; font-weight: 800; flex-shrink: 0;">${idx + 1}</div>
                                        <p style="font-size: 0.9375rem; margin: 0; color: var(--text-main); font-weight: 500;">${fix}</p>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // GSAP Reveal
            gsap.from("#simResultContent > div", {
                duration: 0.8,
                y: 30,
                opacity: 0,
                stagger: 0.2,
                ease: "power2.out"
            });

            simulatorResults.scrollIntoView({ behavior: 'smooth' });
        }

        // Theme Toggle Functionality
        const themeToggleIcon = document.getElementById('themeToggleIcon');
        const body = document.body;

        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark') {
            body.classList.add('dark-theme');
            updateThemeIcon(true);
        }

        themeToggleIcon.addEventListener('click', () => {
            body.classList.toggle('dark-theme');
            const isDark = body.classList.contains('dark-theme');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            updateThemeIcon(isDark);
        });

        function updateThemeIcon(isDark) {
            if (isDark) {
                themeToggleIcon.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>';
            } else {
                themeToggleIcon.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>';
            }
        }

        // Chatbot Functionality
        const closeChat = document.getElementById('closeChat');
        const chatWindow = document.getElementById('chatWindow');
        const chatInput = document.getElementById('chatInput');
        const sendBtn = document.getElementById('sendBtn');
        const chatMessages = document.getElementById('chatMessages');

        // Added back toggle capability for AI Assistant via some trigger if needed, 
        // but for now let's keep it accessible via a function or similar.
        window.toggleChat = function () {
            chatWindow.classList.toggle('open');
            if (chatWindow.classList.contains('open')) {
                chatInput.focus();
            }
        };

        closeChat.addEventListener('click', () => {
            chatWindow.classList.remove('open');
        });

        async function sendMessage() {
            const message = chatInput.value.trim();
            if (!message) return;
            addMessage(message, 'user');
            chatInput.value = '';
            const typingId = addTypingIndicator();
            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message })
                });
                const data = await response.json();
                removeTypingIndicator(typingId);
                if (data.response) addMessage(data.response, 'ai');
                else addMessage(`Error: ${data.error || 'Unknown error'}`, 'ai');
            } catch (error) {
                removeTypingIndicator(typingId);
                addMessage("Connection error. Is the server running?", 'ai');
            }
        }

        function addMessage(text, sender) {
            const div = document.createElement('div');
            div.className = `message message-${sender}`;
            div.textContent = text;
            chatMessages.appendChild(div);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function addTypingIndicator() {
            const id = 'typing-' + Date.now();
            const div = document.createElement('div');
            div.id = id;
            div.className = 'message message-ai typing-indicator';
            div.innerHTML = '<div class="dot" style="display:inline-block; width:4px; height:4px; margin-right:2px; background:currentColor; border-radius:50%; animation: blink 1s infinite alternate;"></div><div class="dot" style="display:inline-block; width:4px; height:4px; margin-right:2px; background:currentColor; border-radius:50%; animation: blink 1s infinite 0.3s alternate;"></div><div class="dot" style="display:inline-block; width:4px; height:4px; background:currentColor; border-radius:50%; animation: blink 1s infinite 0.6s alternate;"></div><style>@keyframes blink { from { opacity: 0.2; } to { opacity: 1; } }</style>';
            chatMessages.appendChild(div);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            return id;
        }

        function removeTypingIndicator(id) {
            const el = document.getElementById(id);
            if (el) el.remove();
        }

        sendBtn.addEventListener('click', sendMessage);
        chatInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(); });

        const resultsData = {{ results | tojson | safe if results else '[]' }};
        const recentMatchesData = {{ recent_matches | tojson | safe if recent_matches else '[]' }};

        function showDetailedAnalysis(index, isRecent = false) {
            console.log("Showing detail for index:", index, "isRecent:", isRecent);
            const res = isRecent ? (recentMatchesData[index] ? recentMatchesData[index].full_analysis : null) : resultsData[index];

            if (!res) {
                console.error("No result data found for index:", index);
                return;
            }

            const content = document.getElementById('detailed-analysis-content');
            if (!content) {
                console.error("Detailed analysis content container not found");
                return;
            }

            content.innerHTML = `
                <div class="analysis-main-card">
                    <div class="analysis-header-row">
                        <div class="candidate-large-avatar">${res.resume_no}</div>
                        <div class="candidate-header-text">
                            <h3>Candidate ${res.resume_no}</h3>
                            <p>${res.role_focus || 'Software Professional'}</p>
                        </div>
                    </div>
                    
                    ${res.evolution ? `
                    <div class="evolution-panel-card mb-4" style="background: linear-gradient(135deg, #10b98110, #3b82f610); border: 1px solid #10b98130; border-radius: 12px; padding: 1.25rem; margin-bottom: 2rem;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <div style="width: 40px; height: 40px; background: var(--success); color: white; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.25rem;">Score</div>
                                <div>
                                    <h4 style="font-size: 0.875rem; font-weight: 700; margin: 0;">Resume Evolution Tracker</h4>
                                    <p style="font-size: 0.75rem; color: var(--text-muted); margin: 0;">Comparing against previous version</p>
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <span style="font-size: 1.25rem; font-weight: 800; color: ${res.evolution.delta >= 0 ? 'var(--success)' : 'var(--danger)'};">${res.evolution.delta >= 0 ? '+' : ''}${res.evolution.delta}%</span>
                                <p style="font-size: 0.625rem; font-weight: 700; text-transform: uppercase; color: var(--text-muted); margin: 0;">Score Delta</p>
                            </div>
                        </div>
                        
                        <div class="evolution-signals" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                            ${res.evolution.signals.map(signal => `
                                <div class="signal-item" style="background: var(--bg-card); padding: 0.75rem; border-radius: 8px; border: 1px solid var(--border);">
                                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem;">
                                        <span style="font-size: 0.75rem;">${signal.type === 'skill_filled' ? 'OK' : signal.type === 'risk_reduced' ? 'Safe' : 'New'}</span>
                                        <span style="font-size: 0.625rem; font-weight: 700; text-transform: uppercase; color: ${signal.impact === 'High' ? 'var(--success)' : 'var(--info)'};">${signal.impact} Impact</span>
                                    </div>
                                    <p style="font-size: 0.75rem; margin: 0; font-weight: 500;">${signal.message}</p>
                                </div>
                            `).join('')}
                        </div>
                        
                        <p style="font-size: 0.8125rem; color: var(--text-main); font-style: italic; background: rgba(255,255,255,0.5); padding: 0.75rem; border-radius: 6px; border-left: 3px solid var(--success); margin: 0;">
                            "${res.evolution.takeaway}"
                        </p>
                    </div>
                    ` : ''}
                    
                    <div class="score-summary-grid">
                        <div class="overall-score-section">
                            <div class="score-display">
                                <span class="score-num">${res.score}</span>
                                <span class="score-den">/ 100</span>
                            </div>
                            <p class="score-tag">Overall Match Score</p>
                        </div>
                        <div class="score-radial-visual">
                            <svg class="radial-progress" viewBox="0 0 36 36">
                                <path class="circle-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                                <path class="circle" stroke-dasharray="${res.score}, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                            </svg>
                        </div>
                    </div>

                    <div class="metrics-row">
                        <div class="mini-metric">
                            <span class="m-val success">${(res.detailed_skills || []).filter(s => s.score > 80).length}</span>
                            <span class="m-label">Matched Skills</span>
                        </div>
                        <div class="mini-metric">
                            <span class="m-val warning">${(res.detailed_skills || []).filter(s => s.score >= 50 && s.score <= 80).length}</span>
                            <span class="m-label">Partial Matches</span>
                        </div>
                        <div class="mini-metric">
                            <span class="m-val danger">${(res.missing_skills || []).length}</span>
                            <span class="m-label">Missing Skills</span>
                        </div>
                    </div>
                </div>

                <div class="analysis-side-panels">
                    <div class="panel-card strengths-panel">
                        <div class="panel-icon">Strengths</div>
                        <ul>
                            ${(res.strengths || []).map(s => `<li>${s}</li>`).join('')}
                        </ul>
                    </div>
                    <div class="panel-card develop-panel">
                        <div class="panel-icon">Areas to Develop</div>
                        <ul>
                            ${(res.areas_to_develop || []).map(a => `<li>${a}</li>`).join('')}
                        </ul>
                    </div>
                </div>

                <div class="full-width-section">
                    <h3>Skills Analysis</h3>
                    <p>Detailed breakdown of skill matches and gaps</p>
                    <div class="skills-list">
                        ${(res.detailed_skills || []).map(skill => `
                            <div class="skill-item-row">
                                <div class="skill-info">
                                    <span class="skill-name">${skill.name}</span>
                                    <span class="skill-level">Proficiency: ${skill.level}</span>
                                </div>
                                <div class="skill-progress-container">
                                    <div class="skill-progress-bar">
                                        <div class="skill-progress-fill" style="width: 0%; background: ${skill.score > 80 ? 'var(--success)' : skill.score > 50 ? 'var(--warning)' : 'var(--danger)'}" data-score="${skill.score}"></div>
                                    </div>
                                    <span class="skill-pct">${skill.score}%</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <div class="full-width-section">
                    <h3>Experience Matching</h3>
                    <div class="exp-grid">
                        ${(res.experience_match || []).map(exp => `
                            <div class="exp-row">
                                <div class="exp-labels">
                                    <span class="exp-title">${exp.label}</span>
                                    <div class="exp-vals">
                                        <span>Candidate: <strong>${exp.candidate}</strong></span>
                                        <span>Required: <strong>${exp.required}</strong></span>
                                    </div>
                                </div>
                                <div class="exp-progress">
                                    <div class="exp-bar"><div class="exp-fill" style="width: 0%" data-score="${exp.pct}"></div></div>
                                    <span class="exp-match-pct">${exp.pct}% Match</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>

                ${res.sample_ideal_resume ? `
                <div class="full-width-section sample-resume-box" style="margin-top: 2rem;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.5rem;">
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <div style="width: 40px; height: 40px; background: var(--primary); color: white; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.25rem;">Doc</div>
                            <div>
                                <h3 style="margin: 0;">Perfect Resume Reference</h3>
                                <p style="font-size: 0.75rem; color: var(--text-muted); margin: 0;">AI-generated sample based on target job description</p>
                            </div>
                        </div>
                        <button onclick="copySampleResume()" class="btn-secondary" style="font-size: 0.75rem; padding: 0.4rem 0.8rem;">Copy Text</button>
                    </div>
                    <div class="sample-resume-content" id="sampleResumeText" style="background: var(--bg-main); border: 1px solid var(--border); border-radius: 12px; padding: 2rem; font-family: 'Courier New', Courier, monospace; font-size: 0.875rem; white-space: pre-wrap; line-height: 1.6; max-height: 400px; overflow-y: auto; color: var(--text-main); position: relative;">
                        ${res.sample_ideal_resume}
                    </div>
                </div>
                ` : ''}

                <div class="full-width-section recommendation-box">
                    <div class="rec-icon">Recommendation</div>
                    <p>${res.recommendation}</p>
                </div>

                <div style="grid-column: 1 / -1; margin-top: 2rem; text-align: center;">
                    <a href="/modify-resume?content=${encodeURIComponent(res.content)}&jd=${encodeURIComponent(resultsData[index] ? resultsData[index].role_focus : '')}" 
                       class="btn-primary" style="padding: 1.25rem 3rem; font-size: 1.1rem; box-shadow: 0 10px 15px -3px rgba(99, 102, 241, 0.4);">
                        Optimize this Resume with AI Templates
                    </a>
                </div>
            `;

            switchView('analysis');

            // Animate progress bars in detailed view
            setTimeout(() => {
                document.querySelectorAll('#analysisView .skill-progress-fill, #analysisView .exp-fill').forEach(fill => {
                    gsap.to(fill, { width: fill.dataset.score + '%', duration: 1, ease: "power2.out" });
                });
            }, 500);
        }

        function copySampleResume() {
            const text = document.getElementById('sampleResumeText').innerText;
            navigator.clipboard.writeText(text).then(() => {
                const btn = event.target;
                const originalText = btn.innerText;
                btn.innerText = 'Copied!';
                btn.style.background = 'var(--success)';
                btn.style.color = 'white';
                setTimeout(() => {
                    btn.innerText = originalText;
                    btn.style.background = '';
                    btn.style.color = '';
                }, 2000);
            });
        }

        function exportToPDF() {
            // Simply use window.print() for now as it's the most reliable browser native 
            // We can add specialized print CSS to dashboard.css
            window.print();
        }

        function switchView(viewId) {
            const views = ['dashboardView', 'newMatchView', 'resultsView', 'analysisView', 'simulatorView'];
            const targetView = document.getElementById(viewId + 'View');

            if (!targetView) return;

            // GSAP Transition: Fade out all, then fade in target
            gsap.to('.view-content', {
                opacity: 0,
                y: 10,
                duration: 0.3,
                display: 'none',
                onComplete: () => {
                    gsap.set(targetView, { display: 'block', opacity: 0, y: 15 });
                    gsap.to(targetView, {
                        opacity: 1,
                        y: 0,
                        duration: 0.5,
                        ease: "power2.out",
                        clearProps: "all"
                    });
                }
            });

            // Update nav active state
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
                if (link.id === 'nav' + viewId.charAt(0).toUpperCase() + viewId.slice(1)) {
                    link.classList.add('active');
                }
            });

            localStorage.setItem('lastView', viewId);
        }

        function showDashboard() { switchView('dashboard'); }
        function showNewMatch() { switchView('newMatch'); }
        function showSimulator() { switchView('simulator'); }
        // Tab Switching for Forms
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const tabName = btn.dataset.tab;
                const container = btn.closest('.form-section');
                container.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                container.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                btn.classList.add('active');
                container.querySelector(`#${tabName}-tab`).classList.add('active');
            });
        });

        // File Selection/Drop Handling
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('resume_files');
        const fileList = document.getElementById('fileList');

        if (dropZone) {
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => {
                dropZone.addEventListener(e, (ev) => { ev.preventDefault(); ev.stopPropagation(); });
            });
            ['dragenter', 'dragover'].forEach(e => {
                dropZone.addEventListener(e, () => dropZone.classList.add('drag-over'));
            });
            ['dragleave', 'drop'].forEach(e => {
                dropZone.addEventListener(e, () => dropZone.classList.remove('drag-over'));
            });
            dropZone.addEventListener('drop', (e) => {
                const files = e.dataTransfer.files;
                fileInput.files = files;
                updateFileList(files);
            });
            fileInput.addEventListener('change', (e) => updateFileList(e.target.files));
        }

        function updateFileList(files) {
            fileList.innerHTML = '';
            Array.from(files).forEach(file => {
                const item = document.createElement('div');
                item.style = 'display: flex; align-items: center; gap: 0.5rem; margin-top: 0.75rem; font-size: 0.75rem; padding: 0.5rem; background: var(--bg-main); border-radius: 6px;';
                item.innerHTML = `<span>üìÑ</span> <span style="flex:1; font-weight:600;">${file.name}</span> <span style="color:var(--text-muted);">${(file.size / 1024).toFixed(1)} KB</span>`;
                fileList.appendChild(item);
            });
        }

        // Animate score bars and reveal elements
        document.addEventListener('DOMContentLoaded', () => {
            // Initial reveal
            gsap.from('.section-card', { opacity: 0, y: 20, stagger: 0.1, duration: 0.8, ease: "power2.out" });
            gsap.from('.metric-card', { opacity: 0, scale: 0.9, stagger: 0.1, duration: 0.8, ease: "back.out(1.7)" });

            setTimeout(() => {
                document.querySelectorAll('.score-fill').forEach(fill => {
                    const score = parseInt(fill.dataset.score);
                    let color = 'var(--danger)';
                    if (score >= 80) color = 'var(--success)';
                    else if (score >= 50) color = 'var(--warning)';

                    fill.style.background = color;
                    gsap.to(fill, { width: score + '%', duration: 1.5, ease: "power2.out" });
                });

                document.querySelectorAll('.status-badge[data-score]').forEach(badge => {
                    const score = parseInt(badge.dataset.score);
                    if (score >= 80) {
                        badge.style.background = 'var(--success-light)';
                        badge.style.color = 'var(--success)';
                    } else if (score >= 50) {
                        badge.style.background = 'var(--warning-light)';
                        badge.style.color = 'var(--warning)';
                    } else {
                        badge.style.background = 'var(--danger-light)';
                        badge.style.color = 'var(--danger)';
                    }
                });
            }, 500);

            // Card Hover Animations
            const cards = document.querySelectorAll('.result-card, .metric-card, .section-card');
            cards.forEach(card => {
                card.addEventListener('mouseenter', () => {
                    gsap.to(card, { y: -5, boxShadow: "0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1)", duration: 0.3, ease: "power2.out" });
                });
                card.addEventListener('mouseleave', () => {
                    gsap.to(card, { y: 0, boxShadow: "var(--shadow-md)", duration: 0.3, ease: "power2.out" });
                });
            });
        });
        // Share Functionality
        async function shareAnalysis() {
            const shareData = {
                title: 'Skill Match AI - Analysis Result',
                text: `I just matched my resume with Skill Match AI! Check out my career readiness.`,
                url: window.location.href
            };

            try {
                if (navigator.share) {
                    await navigator.share(shareData);
                    console.log('Share successful');
                } else {
                    // Fallback: Copy URL to clipboard
                    await navigator.clipboard.writeText(window.location.href);
                    alert('Sharing not supported on this browser. Link copied to clipboard!');
                }
            } catch (err) {
            }
        }
    </script>

    <!-- Profile Modal -->
    <div id="profileModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Your Profile</h3>
                <button class="modal-close" onclick="closeModal('profileModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Full Name</label>
                    <input type="text" id="profileNameInput" class="input-field" value="{{ user.name }}">
                </div>
                <div class="form-group">
                    <label>Email Address</label>
                    <input type="email" class="input-field" value="{{ user.email }}" disabled
                        style="background: var(--bg-main); cursor: not-allowed;">
                </div>
                <div
                    style="display: flex; gap: 1rem; margin-top: 1.5rem; padding: 1.25rem; background: var(--primary-light); border-radius: 12px; border: 1px solid var(--primary-dark);">
                    <div style="font-size: 1.25rem;">üõ°Ô∏è</div>
                    <div style="font-size: 0.8125rem;">
                        <strong>Account Status:</strong> Your account is active. Your resume matching history is being
                        saved securely.
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal('profileModal')">Cancel</button>
                <button class="btn-primary" onclick="saveProfile()">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Account Settings</h3>
                <button class="modal-close" onclick="closeModal('settingsModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div
                    style="display: flex; justify-content: space-between; align-items: center; padding: 1rem 0; border-bottom: 1px solid var(--border);">
                    <div>
                        <div style="font-weight: 700; font-size: 0.9375rem;">Email Notifications</div>
                        <div style="font-size: 0.75rem; color: var(--text-muted);">Receive weekly progress reports and
                            AI tips</div>
                    </div>
                    <div id="toggle-notifications"
                        class="settings-switch {% if session.get('email_notifications', True) %}active{% endif %}"
                        onclick="toggleSetting(this, 'email_notifications')">
                        <div class="switch-dot"></div>
                    </div>
                </div>
                <div
                    style="display: flex; justify-content: space-between; align-items: center; padding: 1rem 0; border-bottom: 1px solid var(--border);">
                    <div>
                        <div style="font-weight: 700; font-size: 0.9375rem;">Privacy Mode</div>
                        <div style="font-size: 0.75rem; color: var(--text-muted);">Hide your profile name from
                            leaderboard</div>
                    </div>
                    <div id="toggle-privacy"
                        class="settings-switch {% if session.get('privacy_mode', False) %}active{% endif %}"
                        onclick="toggleSetting(this, 'privacy_mode')">
                        <div class="switch-dot"></div>
                    </div>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem 0;">
                    <div>
                        <div style="font-weight: 700; font-size: 0.9375rem;">Interface Language</div>
                        <div style="font-size: 0.75rem; color: var(--text-muted);">Default language for AI analysis
                        </div>
                    </div>
                    <div style="font-size: 0.8125rem; font-weight: 700; color: var(--primary);">English (US)</div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-primary" onclick="closeModal('settingsModal')">Close Settings</button>
            </div>
        </div>
        <!-- Salary Simulator Modal -->
        <div id="salaryModal" class="modal-overlay">
            <div class="modal-content" style="max-width: 700px;">
                <div class="modal-header">
                    <div>
                        <h3 style="margin: 0;">Salary Range Simulator</h3>
                        <p style="font-size: 0.75rem; color: var(--text-muted); margin: 0.25rem 0 0;">Estimate
                            data-driven annual
                            compensation packages</p>
                    </div>
                    <button class="modal-close" onclick="closeModal('salaryModal')">&times;</button>
                </div>
                <div class="modal-body" style="padding-top: 1rem;">
                    <div class="simulator-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.25rem;">
                        <div class="form-group">
                            <label>Target Role</label>
                            <input type="text" id="salaryRole" class="input-field"
                                placeholder="e.g. Senior Backend Engineer">
                        </div>
                        <div class="form-group">
                            <label>Target Company</label>
                            <input type="text" id="salaryCompany" class="input-field"
                                placeholder="e.g. Google, Microsoft, Startup">
                        </div>
                        <div class="form-group">
                            <label>Location</label>
                            <input type="text" id="salaryLocation" class="input-field"
                                placeholder="e.g. India, Remote, US">
                        </div>
                        <div class="form-group">
                            <label>Years of Experience: <span id="expVal">5</span></label>
                            <input type="range" id="salaryExp" min="0" max="30" value="5" class="input-field"
                                style="padding: 0; height: auto;"
                                oninput="document.getElementById('expVal').innerText = this.value">
                        </div>
                        <div class="form-group">
                            <label>Education Level</label>
                            <select id="salaryEdu" class="input-field">
                                <option value="Bachelors">Bachelor's Degree</option>
                                <option value="Masters">Master's Degree</option>
                                <option value="PhD">PhD</option>
                                <option value="Self-taught">Self-taught / Bootcamp</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Skill Seniority</label>
                            <select id="salarySeniority" class="input-field">
                                <option value="Beginner">Beginner / Junior</option>
                                <option value="Intermediate" selected>Intermediate / Mid-level</option>
                                <option value="Advanced">Advanced / Expert</option>
                            </select>
                        </div>
                        <div class="form-group" style="grid-column: span 2;">
                            <label>Resume Strength: <span id="scoreVal">85</span>%</label>
                            <input type="range" id="salaryScore" min="0" max="100" value="85" class="input-field"
                                style="padding: 0; height: auto;"
                                oninput="document.getElementById('scoreVal').innerText = this.value">
                        </div>
                    </div>

                    <div id="salaryResultArea" style="margin-top: 2rem; display: none;">
                        <div class="salary-box"
                            style="background: var(--primary-light); border: 1px solid var(--primary-dark); border-radius: 12px; padding: 1.5rem; animation: slideUp 0.5s ease;">
                            <div
                                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <span id="salaryTierBadge" class="status-badge"
                                    style="background: var(--primary); color: white; border: none;"></span>
                                <span id="salaryConfidence" style="font-size: 0.75rem; font-weight: 700;"></span>
                            </div>

                            <div class="salary-range-display"
                                style="display: flex; gap: 1rem; text-align: center; margin-bottom: 1.5rem;">
                                <div style="flex: 1;">
                                    <div
                                        style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase;">
                                        Minimum
                                    </div>
                                    <div id="salaryMin"
                                        style="font-size: 1.25rem; font-weight: 800; color: var(--text-main);">
                                    </div>
                                </div>
                                <div
                                    style="flex: 1; transform: scale(1.1); background: white; border-radius: 8px; padding: 0.5rem; box-shadow: var(--shadow-sm);">
                                    <div
                                        style="font-size: 0.75rem; color: var(--primary); text-transform: uppercase; font-weight: 700;">
                                        Average</div>
                                    <div id="salaryAvg"
                                        style="font-size: 1.5rem; font-weight: 900; color: var(--primary);"></div>
                                </div>
                                <div style="flex: 1;">
                                    <div
                                        style="font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase;">
                                        Maximum
                                    </div>
                                    <div id="salaryMax"
                                        style="font-size: 1.25rem; font-weight: 800; color: var(--text-main);">
                                    </div>
                                </div>
                            </div>

                            <div
                                style="background: rgba(255,255,255,0.5); border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                                <div style="font-weight: 700; font-size: 0.8125rem; margin-bottom: 0.25rem;">Equity &
                                    Bonuses</div>
                                <p id="salaryBonus" style="font-size: 0.8125rem; margin: 0; color: var(--text-muted);">
                                </p>
                            </div>

                            <div style="font-size: 0.8125rem; line-height: 1.5;">
                                <strong>Analysis:</strong> <span id="salaryExplain"
                                    style="color: var(--text-muted);"></span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <p style="font-size: 0.625rem; color: var(--text-muted); flex: 1; margin: 0; font-style: italic;">
                        Estimated values based on current market trends. Not a guarantee of actual offer.
                    </p>
                    <button class="btn-secondary" onclick="closeModal('salaryModal')">Cancel</button>
                    <button id="simulateSalaryBtn" class="btn-primary" onclick="runSalarySimulation()">Simulate
                        Salary</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Modal Handling
        function openSalaryModal() { document.getElementById('salaryModal').classList.add('open'); }
        function openSettingsModal() { document.getElementById('settingsModal').classList.add('open'); }
        function closeModal(id) { document.getElementById(id).classList.remove('open'); }

        async function runSalarySimulation() {
            const btn = document.getElementById('simulateSalaryBtn');
            const resultArea = document.getElementById('salaryResultArea');
            const data = {
                role: document.getElementById('salaryRole').value,
                company: document.getElementById('salaryCompany').value,
                location: document.getElementById('salaryLocation').value,
                experience: document.getElementById('salaryExp').value,
                edu: document.getElementById('salaryEdu').value,
                seniority: document.getElementById('salarySeniority').value,
                score: document.getElementById('salaryScore').value
            };

            if (!data.role || !data.company || !data.location) {
                alert("Please fill in role, company and location.");
                return;
            }

            btn.disabled = true;
            btn.innerText = "Analyzing...";

            try {
                const response = await fetch('/simulate-salary', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const res = await response.json();
                if (res.status === 'success') {
                    const s = res.data;
                    document.getElementById('salaryTierBadge').innerText = s.company_tier;
                    document.getElementById('salaryConfidence').innerText = `Confidence: ${s.confidence}`;
                    document.getElementById('salaryMin').innerText = s.salary_range.min;
                    document.getElementById('salaryAvg').innerText = s.salary_range.avg;
                    document.getElementById('salaryMax').innerText = s.salary_range.max;
                    document.getElementById('salaryBonus').innerText = s.bonus_stock;
                    document.getElementById('salaryExplain').innerText = s.explanation;

                    resultArea.style.display = 'block';
                    gsap.from('#salaryResultArea', { opacity: 0, y: 20, duration: 0.5 });
                }
            } catch (err) {
                console.error("Salary simulation failed", err);
            } finally {
                btn.disabled = false;
                btn.innerText = "Simulate Salary";
            }
        }

        async function toggleSetting(element, settingName) {
            const newValue = !element.classList.contains('active');
            try {
                const response = await fetch('/toggle-setting', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ setting: settingName, value: newValue })
                });
                const data = await response.json();
                if (data.status === 'success') {
                    element.classList.toggle('active', newValue);
                }
            } catch (err) {
                console.error(`Failed to toggle ${settingName}`, err);
            }
        }

        async function saveProfile() {
            const newName = document.getElementById('profileNameInput').value;
            try {
                const response = await fetch('/update-profile', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: newName })
                });
                const data = await response.json();
                if (data.status === 'success') {
                    // Update UI immediately
                    document.querySelector('.user-display-name').textContent = data.name;
                    document.querySelector('.avatar').textContent = data.name.substring(0, 2).toUpperCase();
                    closeModal('profileModal');

                    // Show success notification or similar
                    alert("Profile updated successfully!");
                }
            } catch (err) {
                console.error("Failed to update profile", err);
            }
        }

        // Profile Interaction Logic
        document.addEventListener('DOMContentLoaded', () => {
            const profileBtn = document.getElementById('userProfileBtn');
            const profileDropdown = profileBtn?.querySelector('.profile-dropdown');

            if (!profileBtn || !profileDropdown) {
                console.error("Profile components not found");
                return;
            }

            let dropdownTimeout;

            profileBtn.addEventListener('click', (e) => {
                // If the click happened inside the dropdown, don't intercept it
                if (profileDropdown.contains(e.target)) return;

                e.preventDefault();
                e.stopPropagation();

                // Clear any pending opening animation
                clearTimeout(dropdownTimeout);

                // Toggle behavior
                if (profileDropdown.classList.contains('show')) {
                    profileDropdown.classList.remove('show');
                } else {
                    // Artificial delay for premium feel (200ms)
                    dropdownTimeout = setTimeout(() => {
                        profileDropdown.classList.add('show');
                    }, 200);
                }
            });

            // Close dropdown when clicking anywhere else
            document.addEventListener('click', (e) => {
                if (!profileBtn.contains(e.target)) {
                    clearTimeout(dropdownTimeout);
                    profileDropdown.classList.remove('show');
                }
            });
        });

        // Close modal on click outside
        window.onclick = function (event) {
            if (event.target.classList.contains('modal-overlay')) {
                event.target.classList.remove('open');
            }
        }

        // Existing JS Logic...
    </script>
</body>

</html>