<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Optimize Resume - Skill Match AI</title>
    <!-- Use the same premium stylesheet as the dashboard -->
    <link rel="stylesheet" href="{{ url_for('static', filename='dashboard.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <style>
        :root {
            --editor-bg: #ffffff;
            --editor-text: #0f172a;
        }

        .dark-theme :root {
            --editor-bg: #1e293b;
            --editor-text: #f1f5f9;
        }

        body {
            background: var(--bg-main);
            color: var(--text-main);
            overflow: hidden;
            /* Prevent body scroll, use panel scroll */
        }

        .editor-layout {
            display: grid;
            grid-template-columns: 1fr 400px;
            height: calc(100vh - 70px);
            background: var(--bg-main);
            overflow: hidden;
        }

        .editor-pane {
            background: #f8fafc;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow-y: auto;
            align-items: center;
            padding: 3rem 0;
        }

        .editor-container {
            width: 210mm;
            min-height: 297mm;
            background: white;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            padding: 50px 60px;
            position: relative;
            margin-bottom: 2rem;
        }

        .analysis-pane {
            background: var(--bg-card);
            padding: 2rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            border-left: 1px solid var(--border);
        }

        #resume-editor {
            width: 100%;
            height: auto;
            min-height: 250mm;
            border: none;
            outline: none;
            background: transparent;
            color: #1e293b;
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            line-height: 1.6;
            resize: none;
            padding: 0;
            white-space: pre-wrap;
            overflow: hidden;
        }

        .dark-theme .editor-pane {
            background: #0f172a;
        }

        .dark-theme .editor-container {
            background: #1e293b;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3);
        }

        .dark-theme #resume-editor {
            color: #f1f5f9;
        }

        /* Visual Templates */
        .editor-container.template-classic {
            font-family: 'Georgia', serif;
            color: #1a1a1a;
            border-top: 8px solid #334155;
        }

        .editor-container.template-modern {
            font-family: 'Inter', sans-serif;
            border-left: 12px solid var(--primary);
        }

        .editor-container.template-minimal {
            font-family: 'Inter', sans-serif;
            padding: 80px;
            background: #fafafa;
        }

        .editor-container.template-minimal #resume-editor {
            font-size: 0.95rem;
            color: #475569;
        }

        .visual-tpl-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
            margin-bottom: 2rem;
        }

        .visual-tpl-card {
            background: var(--bg-main);
            border: 2px solid transparent;
            border-radius: 10px;
            padding: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .visual-tpl-card:hover {
            border-color: var(--primary-light);
        }

        .visual-tpl-card.active {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.05);
        }

        .visual-tpl-card .thumb {
            height: 60px;
            background: white;
            border: 1px solid var(--border);
            border-radius: 4px;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .visual-tpl-card span {
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--text-main);
        }

        .stat-card {
            background: var(--bg-main);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: var(--shadow-sm);
        }

        .score-large {
            text-align: center;
            padding: 1rem 0;
        }

        .score-large .val {
            font-size: 3.5rem;
            font-weight: 800;
            color: var(--primary);
            line-height: 1;
            display: block;
        }

        .score-large .label {
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            margin-top: 0.5rem;
        }

        .progress-container {
            height: 8px;
            background: var(--border);
            border-radius: 4px;
            margin: 1rem 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary);
            width: 0%;
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .suggestion-item {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 1rem;
            font-size: 0.875rem;
            line-height: 1.5;
        }

        .suggestion-icon {
            width: 20px;
            height: 20px;
            background: var(--primary-light);
            color: var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            flex-shrink: 0;
            margin-top: 0.125rem;
        }

        .template-selector {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .tpl-card {
            padding: 1rem;
            border: 1px solid var(--border);
            border-radius: 10px;
            cursor: pointer;
            transition: var(--transition);
            background: var(--bg-card);
        }

        .tpl-card:hover {
            border-color: var(--primary);
            background: var(--primary-light);
        }

        .tpl-card.active {
            border-color: var(--primary);
            background: var(--primary-light);
            box-shadow: 0 0 0 2px var(--primary);
        }

        .tpl-card h4 {
            font-size: 0.875rem;
            margin-bottom: 0.25rem;
        }

        .tpl-card p {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* Dark Mode Support for Editor Pane */
        .dark-theme .editor-pane {
            background: #0f172a;
        }

        .dark-theme #resume-editor {
            background: #0f172a;
        }

        /* Print Styles for PDF Export */
        @media print {
            body {
                background: white !important;
                overflow: visible !important;
            }

            .nav-container,
            .analysis-pane,
            .btn-primary,
            .btn-secondary,
            .share-btn,
            .nav-right,
            header {
                display: none !important;
            }

            .editor-layout {
                display: block !important;
                background: white !important;
                height: auto !important;
            }

            .editor-pane {
                background: white !important;
                padding: 0 !important;
                display: block !important;
                overflow: visible !important;
            }

            .editor-container {
                box-shadow: none !important;
                margin: 0 !important;
                padding: 0 !important;
                width: 100% !important;
            }

            #resume-editor {
                font-size: 11pt !important;
                color: black !important;
                background: transparent !important;
            }
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--bg-card);
            padding: 2.5rem;
            border-radius: 20px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }

        .close-modal {
            position: absolute;
            top: 1.5rem;
            right: 1.5rem;
            cursor: pointer;
            font-size: 1.5rem;
            color: var(--text-muted);
        }

        .sample-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .sample-card {
            border: 1px solid var(--border);
            padding: 1.5rem;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--bg-main);
        }

        .sample-card:hover {
            transform: translateY(-4px);
            border-color: var(--primary);
            box-shadow: var(--shadow-md);
        }

        .sample-card h4 {
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
        }

        .sample-card p {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .sample-tag {
            display: inline-block;
            font-size: 0.625rem;
            padding: 0.2rem 0.6rem;
            background: var(--primary-light);
            color: var(--primary);
            border-radius: 20px;
            font-weight: 700;
            margin-top: 0.5rem;
        }
    </style>
</head>

<body class="dark-theme"> <!-- Default to dark for premium feel -->
    <header class="header">
        <div class="header-content">
            <div class="nav-left">
                <a href="/" class="logo">
                    <div class="logo-icon">
                        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path
                                d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"
                                fill="url(#ai-grad-editor)" />
                            <circle cx="12" cy="12" r="4" fill="white" fill-opacity="0.2" />
                            <path d="m9 12 2 2 4-4" stroke="white" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round" />
                            <defs>
                                <linearGradient id="ai-grad-editor" x1="3" y1="3" x2="21" y2="21"
                                    gradientUnits="userSpaceOnUse">
                                    <stop stop-color="#6366f1" />
                                    <stop offset="1" stop-color="#a855f7" />
                                </linearGradient>
                            </defs>
                        </svg>
                    </div>
                    <h1>Resume Optimizer</h1>
                </a>
            </div>
            <button class="btn-secondary" onclick="togglePreview()">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                    <circle cx="12" cy="12" r="3"></circle>
                </svg>
                Preview Mode
            </button>
            <a href="/" class="btn-secondary">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                    <polyline points="9 22 9 12 15 12 15 22"></polyline>
                </svg>
                Exit Editor
            </a>
            <button class="btn-primary" onclick="exportEditedResume()">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7 10 12 15 17 10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>
                Export Final
            </button>
        </div>
        </div>
    </header>

    <main class="editor-layout">
        <!-- Main Editor Pane -->
        <section class="editor-pane">
            <div class="editor-container">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                    <div class="live-indicator">
                        <span class="pulse"></span>
                        AI Optimizer Active
                    </div>
                    <div
                        style="font-size: 0.75rem; color: var(--text-muted); font-weight: 600; text-transform: uppercase; letter-spacing: 1px;">
                        Interactive Document
                    </div>
                </div>
                <textarea id="resume-editor" spellcheck="false"
                    placeholder="Paste your resume content here...">{{ content }}</textarea>
            </div>

            <div style="position: sticky; bottom: 2rem; display: flex; gap: 1rem; z-index: 100;">
                <button class="btn-primary" onclick="useGoldenSample()"
                    style="border-radius: 30px; padding: 0.75rem 1.5rem; display: flex; align-items: center; gap: 0.5rem; box-shadow: var(--shadow-lg); background: #059669;">
                    <span>‚ú® Use Golden Sample</span>
                </button>
                <button class="btn-secondary" onclick="openGallery()"
                    style="border-radius: 30px; padding: 0.75rem 1.5rem; display: flex; align-items: center; gap: 0.5rem; box-shadow: var(--shadow-lg); background: white; color: #1e293b; border: 1px solid #e2e8f0;">
                    <span>üìÇ Select from Gallery</span>
                </button>
                <button class="btn-primary share-btn"
                    style="border-radius: 30px; padding: 0.75rem 1.5rem; display: flex; align-items: center; gap: 0.5rem; box-shadow: var(--shadow-lg);">
                    <span>üì§ Share Link</span>
                </button>
            </div>
        </section>

        <!-- Template Gallery Modal -->
        <div id="gallery-modal" class="modal">
            <div class="modal-content">
                <span class="close-modal" onclick="closeGallery()">&times;</span>
                <h2 style="font-size: 1.5rem; font-weight: 800; color: var(--text-main);">Select a Sample Template</h2>
                <p style="color: var(--text-muted); font-size: 0.875rem;">Choose a pre-written resume that matches your
                    role to get started.</p>

                <div class="sample-grid">
                    <div class="sample-card" onclick="loadSample('SDE')">
                        <h4>Software Engineer</h4>
                        <p>Focuses on full-stack development, cloud infra, and algorithms.</p>
                        <span class="sample-tag">100 Match</span>
                    </div>
                    <div class="sample-card" onclick="loadSample('DevOps')">
                        <h4>DevOps Professional</h4>
                        <p>Focuses on CI/CD, Kubernetes, and Observability.</p>
                        <span class="sample-tag">98 Match</span>
                    </div>
                    <div class="sample-card" onclick="loadSample('Product')">
                        <h4>Product Manager</h4>
                        <p>Focuses on strategy, roadmap, and user metrics.</p>
                        <span class="sample-tag">97 Match</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dynamic Analysis Pane -->
        <aside class="analysis-pane">
            <!-- Visual Template Selector -->
            <div class="stat-card">
                <h3 style="font-size: 0.9375rem; margin-bottom: 1rem;">Visual Layouts</h3>
                <div class="visual-tpl-grid">
                    <div class="visual-tpl-card active" onclick="setVisualTemplate('modern')">
                        <div class="thumb">üìÑ</div>
                        <span>Modern</span>
                    </div>
                    <div class="visual-tpl-card" onclick="setVisualTemplate('classic')">
                        <div class="thumb">üìú</div>
                        <span>Classic</span>
                    </div>
                    <div class="visual-tpl-card" onclick="setVisualTemplate('minimal')">
                        <div class="thumb">üìù</div>
                        <span>Minimal</span>
                    </div>
                </div>
            </div>

            <!-- Score Card -->
            <div class="stat-card score-large">
                <div class="val" id="score-val">--</div>
                <div class="label">ATS Match Score</div>
                <div class="progress-container">
                    <div class="progress-fill" id="score-bar"></div>
                </div>
                <p id="match-status" style="font-size: 0.8125rem; font-weight: 600;"></p>
            </div>

            <!-- Templates Section -->
            <div class="stat-card">
                <h3 style="font-size: 0.9375rem; margin-bottom: 1rem;">Target AI Templates</h3>
                <div class="template-selector">
                    {% for key, tpl in templates.items() %}
                    <div class="tpl-card {% if loop.first %}active{% endif %}" onclick="selectTemplate('{{ key }}')">
                        <h4>{{ key }} Style</h4>
                        <p>{{ tpl.description }}</p>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- AI Insights -->
            <div class="stat-card">
                <h3 style="font-size: 0.9375rem; margin-bottom: 1rem;">Live AI Suggestions</h3>
                <div id="suggestions-list">
                    <div style="color: var(--text-muted); font-size: 0.875rem;">Start editing to see live
                        improvements...</div>
                </div>
            </div>

            <!-- Perfect Resume Reference (Golden Sample) -->
            <div class="stat-card" id="perfect-resume-container" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h3 style="font-size: 0.9375rem; color: var(--primary);">Perfect Resume Reference</h3>
                    <button onclick="copySampleResume()"
                        style="background: transparent; border: none; color: var(--primary); font-size: 0.75rem; cursor: pointer; font-weight: 600;">Copy</button>
                </div>
                <div id="perfect-resume-text"
                    style="font-family: 'Courier New', Courier, monospace; font-size: 0.75rem; background: var(--bg-main); padding: 1rem; border-radius: 8px; border: 1px dashed var(--primary); white-space: pre-wrap; max-height: 300px; overflow-y: auto; color: var(--text-main);">
                </div>
            </div>
        </aside>
    </main>

    <script>
        const editor = document.getElementById('resume-editor');
        const scoreVal = document.getElementById('score-val');
        const scoreBar = document.getElementById('score-bar');
        const statusText = document.getElementById('match-status');
        const suggestionsList = document.getElementById('suggestions-list');
        const jdContext = {{ jd | tojson }};
        let currentTemplate = 'Google'; // Default

        let debounceTimer;

        editor.addEventListener('input', () => {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(performLiveAnalysis, 800);
        });

        async function performLiveAnalysis() {
            const content = editor.value.trim();
            if (content.length < 30) return;

            // Show loading state
            scoreVal.innerText = '...';
            scoreBar.style.width = '0%';
            statusText.innerText = 'Analyzing...';
            statusText.style.color = 'var(--text-muted)';

            try {
                const response = await fetch('/modify-resume', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content, jd: jdContext, template: currentTemplate })
                });

                if (!response.ok) throw new Error('Network response was not ok');

                const data = await response.json();
                updateUI(data);
            } catch (err) {
                console.error("Sync failed:", err);
                scoreVal.innerText = 'Err';
                statusText.innerText = 'Reconnect failed. Trying again...';
                statusText.style.color = 'var(--danger)';
            }
        }

        function updateUI(data) {
            // Update Score
            const score = data.score || 0;
            scoreVal.innerText = score + '%';
            scoreBar.style.width = score + '%';

            // Color feedback
            if (score >= 80) {
                scoreBar.style.background = 'var(--success)';
                statusText.innerText = 'Excellent Alignment';
                statusText.style.color = 'var(--success)';
            } else if (score >= 50) {
                scoreBar.style.background = 'var(--warning)';
                statusText.innerText = 'Moderate Alignment';
                statusText.style.color = 'var(--warning)';
            } else {
                scoreBar.style.background = 'var(--danger)';
                statusText.innerText = 'Weak Alignment';
                statusText.style.color = 'var(--danger)';
            }

            // Update Suggestions
            suggestionsList.innerHTML = '';
            const tips = data.tips || data.roadmap || [];

            if (tips.length === 0) {
                suggestionsList.innerHTML = '<div style="color: var(--text-muted); font-size: 0.875rem;">Resume looks solid! Keep refining.</div>';
            }

            tips.slice(0, 5).forEach(tip => {
                const div = document.createElement('div');
                div.className = 'suggestion-item fade-in';
                div.innerHTML = `
                    <div class="suggestion-icon">‚ú®</div>
                    <div>${tip}</div>
                `;
                suggestionsList.appendChild(div);
            });

            // GSAP Animation for new items
            gsap.from('.fade-in', { opacity: 0, y: 10, duration: 0.4, stagger: 0.1 });

            // Update Golden Sample
            const sampleContainer = document.getElementById('perfect-resume-container');
            const sampleText = document.getElementById('perfect-resume-text');
            if (data.sample_ideal_resume) {
                sampleContainer.style.display = 'block';
                sampleText.innerText = data.sample_ideal_resume;
            }
        }

        async function copySampleResume() {
            const text = document.getElementById('perfect-resume-text').innerText;
            try {
                await navigator.clipboard.writeText(text);
                const btn = event.target;
                const originalText = btn.innerText;
                btn.innerText = 'Copied!';
                setTimeout(() => btn.innerText = originalText, 2000);
            } catch (err) {
                console.error("Copy failed:", err);
            }
        }

        function selectTemplate(name) {
            currentTemplate = name;
            document.querySelectorAll('.tpl-card').forEach(c => {
                c.classList.remove('active');
                if (c.innerText.includes(name)) c.classList.add('active');
            });
            // Re-trigger analysis immediately with the new template
            performLiveAnalysis();
        }

        function exportEditedResume() {
            // Trigger browser print which we've styled for PDF
            window.print();
        }

        function setVisualTemplate(type) {
            const container = document.querySelector('.editor-container');
            container.classList.remove('template-modern', 'template-classic', 'template-minimal');
            container.classList.add('template-' + type);

            document.querySelectorAll('.visual-tpl-card').forEach(c => {
                c.classList.remove('active');
                if (c.innerText.toLowerCase().includes(type)) c.classList.add('active');
            });
        }

        function openGallery() {
            document.getElementById('gallery-modal').style.display = 'flex';
        }

        function closeGallery() {
            document.getElementById('gallery-modal').style.display = 'none';
        }

        function loadSample(type) {
            const samples = {
                'SDE': 'IMPROVED RESUME - SOFTWARE ENGINEER\n\nCore Skills: Java, Python, C++, Data Structures, Distributed Systems\n\nExperience: Designed APIs handling 10k+ users, increased performance by 40%...',
                'DevOps': 'IMPROVED RESUME - DEVOPS ENGINEER\n\nCore Skills: Kubernetes, Docker, Terraform, AWS, Jenkins\n\nExperience: Reduced deployment time by 60%, implemented zero-downtime infra...',
                'Product': 'IMPROVED RESUME - PRODUCT MANAGER\n\nCore Skills: Agile, Product Roadmap, Market Analysis, SQL\n\nExperience: Managed product lifecycle for 500k active users, increased retention by 15%...'
            };
            editor.value = samples[type];
            closeGallery();
            performLiveAnalysis();
        }

        function useGoldenSample() {
            const golden = document.getElementById('perfect-resume-text').innerText;
            if (golden && golden.trim().length > 10) {
                editor.value = golden;
                performLiveAnalysis();
            } else {
                alert('The Golden Sample is still being generated or is unavailable.');
            }
        }

        function exportEditedResume() {
            window.print();
        }

        async function shareEditedResume() {
            const shareData = {
                title: 'My Optimized Resume',
                text: 'Check out my optimized resume from Skill Match AI!',
                url: window.location.href
            };
            try {
                if (navigator.share) {
                    await navigator.share(shareData);
                } else {
                    await navigator.clipboard.writeText(window.location.href);
                    alert('Link copied to clipboard!');
                }
            } catch (err) {
                console.error('Share failed:', err);
            }
        }

        function togglePreview() {
            const aside = document.querySelector('.analysis-pane');
            const editorPane = document.querySelector('.editor-pane');
            const isHidden = aside.style.display === 'none';

            if (isHidden) {
                aside.style.display = 'flex';
                document.querySelector('.editor-layout').style.gridTemplateColumns = '1fr 400px';
                editorPane.style.padding = '3rem 0';
            } else {
                aside.style.display = 'none';
                document.querySelector('.editor-layout').style.gridTemplateColumns = '1fr';
                editorPane.style.padding = '5rem 0';
            }
        }

        document.querySelector('.share-btn')?.addEventListener('click', shareEditedResume);

        // Initial Analysis
        if (editor.value.length > 20) {
            performLiveAnalysis();
        }
    </script>
</body>

</html>